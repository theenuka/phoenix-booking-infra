---
- name: Create argocd namespace
  kubernetes.core.k8s:
    name: argocd
    api_version: v1
    kind: Namespace
    state: present

- name: Install ArgoCD
  kubernetes.core.k8s:
    src: "{{ role_path }}/../../../k8s/argocd-install.yaml"
    state: present
    namespace: argocd

- name: Install Argo CD Image Updater
  kubernetes.core.k8s:
    src: "{{ role_path }}/../../../k8s/argocd-image-updater-install.yaml"
    state: present
    namespace: argocd

- name: Wait for ArgoCD server to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: argocd-server
    namespace: argocd
  register: argocd_server_deployment
  until: "argocd_server_deployment.resources[0].status.availableReplicas is defined and argocd_server_deployment.resources[0].status.availableReplicas > 0"
  retries: 30
  delay: 10

- name: Create ArgoCD TLS Secret
  copy:
    dest: /tmp/argocd-tls-secret.yaml
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: argocd-server-tls
        namespace: argocd
      type: kubernetes.io/tls
      data:
        tls.crt: $(cat /Users/theenukabandara/.gemini/tmp/327cf57fbdbfa23fe90a2378538922d1dc2474a6c13c677d92c7af186d987422/argocd-tls.crt | base64 | tr -d '\n')
        tls.key: $(cat /Users/theenukabandara/.gemini/tmp/327cf57fbdbfa23fe90a2378538922d1dc2474a6c13c677d92c7af186d987422/argocd-tls.key | base64 | tr -d '\n')

- name: Apply ArgoCD TLS Secret
  shell: kubectl apply -f /tmp/argocd-tls-secret.yaml

- name: Apply ArgoCD Server Deployment with TLS
  copy:
    dest: /tmp/argocd-server-deployment-tls.yaml
    content: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-server
        namespace: argocd
      spec:
        template:
          spec:
            containers:
            - name: argocd-server
              args:
              - /usr/local/bin/argocd-server
              - --tls-cert-path=/app/config/customer/tls/tls.crt
              - --tls-key-path=/app/config/customer/tls/tls.key
              volumeMounts:
              - name: argocd-server-tls
                mountPath: /app/config/customer/tls
            volumes:
            - name: argocd-server-tls
              secret:
                secretName: argocd-server-tls
- name: Apply ArgoCD Server Deployment with TLS
  shell: kubectl apply -f /tmp/argocd-server-deployment-tls.yaml

- name: Create ArgoCD Ingress Manifest
  copy:
    dest: /tmp/argocd-ingress.yaml
    content: |
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: argocd-server-ingress
        namespace: argocd
        annotations:
          alb.ingress.kubernetes.io/scheme: internet-facing
          alb.ingress.kubernetes.io/target-type: ip
          alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
          alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
      spec:
        ingressClassName: alb
        rules:
          - http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: argocd-server
                      port:
                        number: 80
        tls:
        - hosts:
          - k8s-argocd-argocdse-f4b1608958-507457971.us-east-1.elb.amazonaws.com
          secretName: argocd-server-tls
- name: Apply ArgoCD Ingress
  shell: kubectl apply -f /tmp/argocd-ingress.yaml

- name: Create Root App Manifest
  copy:
    dest: /tmp/root-app.yaml
    content: |
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: platform-apps
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: https://github.com/theenuka/pheonix-booking-config-repo.git
          targetRevision: master
          path: app-of-apps/platform
        destination:
          server: https://kubernetes.default.svc
          namespace: argocd
      ---
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: business-apps
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: https://github.com/theenuka/pheonix-booking-config-repo.git
          targetRevision: master
          path: app-of-apps/apps
        destination:
          server: https://kubernetes.default.svc
          namespace: argocd
- name: Apply Root App
  shell: kubectl apply -f /tmp/root-app.yaml